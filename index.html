<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Masajes</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;
        const { Calendar, Clock, User, Phone, Trash2, Plus, Save, Download, Upload } = lucide;

        const MassageScheduler = () => {
          const [appointments, setAppointments] = useState([]);
          const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
          const [showNewAppointment, setShowNewAppointment] = useState(false);
          const [newAppointment, setNewAppointment] = useState({
            time: '',
            duration: '60',
            clientName: '',
            clientPhone: '',
            service: ''
          });

          // Cargar datos del localStorage al iniciar
          useEffect(() => {
            try {
              const savedAppointments = localStorage.getItem('massage-appointments');
              if (savedAppointments) {
                const parsed = JSON.parse(savedAppointments);
                setAppointments(parsed);
                console.log('Datos cargados:', parsed);
              }
            } catch (error) {
              console.error('Error cargando datos:', error);
            }
          }, []);

          // Guardar datos en localStorage cada vez que cambien las citas
          useEffect(() => {
            try {
              localStorage.setItem('massage-appointments', JSON.stringify(appointments));
              console.log('Datos guardados automáticamente');
            } catch (error) {
              console.error('Error guardando datos:', error);
            }
          }, [appointments]);

          // Generar slots de tiempo disponibles
          const generateTimeSlots = useCallback(() => {
            const slots = [];
            for (let hour = 8; hour < 16; hour++) {
              for (let minute = 0; minute < 60; minute += 15) {
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                slots.push(timeString);
              }
            }
            return slots;
          }, []);

          const timeSlots = generateTimeSlots();

          // Verificar si un slot está disponible
          const isSlotAvailable = useCallback((time, duration, currentAppointments) => {
            const [hours, minutes] = time.split(':').map(Number);
            const startTime = hours * 60 + minutes;
            const endTime = startTime + parseInt(duration);
            
            if (endTime > 16 * 60) return false;

            const dayAppointments = currentAppointments.filter(app => app.date === selectedDate);
            
            return !dayAppointments.some(appointment => {
              const [appHours, appMinutes] = appointment.time.split(':').map(Number);
              const appStart = appHours * 60 + appMinutes;
              const appEnd = appStart + parseInt(appointment.duration);
              
              return (startTime < appEnd && endTime > appStart);
            });
          }, [selectedDate]);

          // Obtener slots disponibles para la duración seleccionada
          const getAvailableSlots = useCallback((duration) => {
            return timeSlots.filter(time => isSlotAvailable(time, duration, appointments));
          }, [timeSlots, isSlotAvailable, appointments]);

          // Manejar nueva cita
          const handleAddAppointment = useCallback(() => {
            if (!newAppointment.time || !newAppointment.clientName.trim()) {
              alert('Por favor completa los campos obligatorios (Horario y Nombre del cliente).');
              return;
            }
            
            if (!isSlotAvailable(newAppointment.time, newAppointment.duration, appointments)) {
              alert('Este horario no está disponible. Por favor selecciona otro.');
              return;
            }

            const appointment = {
              id: `${Date.now()}-${Math.random()}`,
              date: selectedDate,
              time: newAppointment.time,
              duration: newAppointment.duration,
              clientName: newAppointment.clientName.trim(),
              clientPhone: newAppointment.clientPhone.trim(),
              service: newAppointment.service.trim(),
              createdAt: new Date().toISOString()
            };
            
            setAppointments(prev => {
              const updated = [...prev, appointment];
              console.log('Nueva cita agregada:', appointment);
              return updated;
            });
            
            // Reset form
            setNewAppointment({
              time: '',
              duration: '60',
              clientName: '',
              clientPhone: '',
              service: ''
            });
            setShowNewAppointment(false);
            
            alert('¡Cita agendada y guardada exitosamente!');
          }, [newAppointment, selectedDate, appointments, isSlotAvailable]);

          // Cancelar cita
          const handleCancelAppointment = useCallback((appointmentId) => {
            console.log('Cancelando cita ID:', appointmentId);
            
            if (window.confirm('¿Estás seguro de que quieres cancelar esta cita?')) {
              setAppointments(prev => {
                const filtered = prev.filter(app => app.id !== appointmentId);
                console.log('Cita eliminada, nuevas citas:', filtered);
                return filtered;
              });
              alert('Cita cancelada y eliminada permanentemente');
            }
          }, []);

          // Exportar datos como respaldo
          const handleExportData = () => {
            try {
              const dataStr = JSON.stringify(appointments, null, 2);
              const dataBlob = new Blob([dataStr], {type: 'application/json'});
              const url = URL.createObjectURL(dataBlob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `agenda-masajes-${new Date().toISOString().split('T')[0]}.json`;
              link.click();
              URL.revokeObjectURL(url);
              alert('Datos exportados exitosamente');
            } catch (error) {
              console.error('Error exportando:', error);
              alert('Error al exportar datos');
            }
          };

          // Importar datos desde respaldo
          const handleImportData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData)) {
                  if (window.confirm('¿Quieres reemplazar todas las citas existentes con los datos importados?')) {
                    setAppointments(importedData);
                    alert('Datos importados exitosamente');
                  }
                } else {
                  alert('Formato de archivo inválido');
                }
              } catch (error) {
                console.error('Error importando:', error);
                alert('Error al leer el archivo');
              }
            };
            reader.readAsText(file);
            event.target.value = '';
          };

          // Limpiar todos los datos
          const handleClearAllData = () => {
            if (window.confirm('¿CUIDADO! ¿Estás seguro de que quieres eliminar TODAS las citas? Esta acción no se puede deshacer.')) {
              if (window.confirm('¿Estás REALMENTE seguro? Se perderán todas las citas guardadas.')) {
                setAppointments([]);
                localStorage.removeItem('massage-appointments');
                alert('Todos los datos han sido eliminados');
              }
            }
          };

          // Obtener citas del día seleccionado
          const getDayAppointments = useCallback(() => {
            return appointments
              .filter(app => app.date === selectedDate)
              .sort((a, b) => a.time.localeCompare(b.time));
          }, [appointments, selectedDate]);

          // Formatear fecha
          const formatDate = (dateString) => {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-ES', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          };

          // Calcular hora de fin
          const calculateEndTime = (startTime, duration) => {
            const [hours, minutes] = startTime.split(':').map(Number);
            const endMinutes = hours * 60 + minutes + parseInt(duration);
            const endHours = Math.floor(endMinutes / 60);
            const endMins = endMinutes % 60;
            return `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
          };

          const dayAppointments = getDayAppointments();
          const availableSlots = getAvailableSlots(newAppointment.duration);

          return (
            <div className="max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
              <div className="bg-white rounded-lg shadow-xl p-6">
                <div className="flex items-center justify-between mb-6">
                  <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <Calendar className="text-blue-600" />
                    Agenda de Masajes
                  </h1>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowNewAppointment(true)}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 transition-colors"
                    >
                      <Plus size={20} />
                      Nueva Cita
                    </button>
                  </div>
                </div>

                {/* Panel de información y respaldo */}
                <div className="mb-6 bg-gray-50 rounded-lg p-4">
                  <div className="flex flex-wrap items-center justify-between gap-4">
                    <div className="text-sm text-gray-600">
                      <span className="font-semibold">📊 Total de citas:</span> {appointments.length} | 
                      <span className="font-semibold"> 📅 Citas del día:</span> {dayAppointments.length} |
                      <span className="font-semibold text-green-600"> 💾 Guardado automático activo</span>
                    </div>
                    
                    <div className="flex gap-2">
                      <button
                        onClick={handleExportData}
                        className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 flex items-center gap-1"
                        title="Exportar respaldo"
                      >
                        <Download size={16} />
                        Exportar
                      </button>
                      
                      <label className="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 cursor-pointer flex items-center gap-1">
                        <Upload size={16} />
                        Importar
                        <input
                          type="file"
                          accept=".json"
                          onChange={handleImportData}
                          className="hidden"
                        />
                      </label>
                      
                      <button
                        onClick={handleClearAllData}
                        className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 flex items-center gap-1"
                        title="Eliminar todos los datos"
                      >
                        <Trash2 size={16} />
                        Limpiar Todo
                      </button>
                    </div>
                  </div>
                </div>

                {/* Selector de fecha */}
                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Seleccionar fecha:
                  </label>
                  <input
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  <p className="text-sm text-gray-600 mt-1 capitalize">
                    {formatDate(selectedDate)}
                  </p>
                </div>

                {/* Lista de citas del día */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div>
                    <h2 className="text-xl font-semibold text-gray-800 mb-4">
                      Citas programadas ({dayAppointments.length})
                    </h2>
                    
                    {dayAppointments.length === 0 ? (
                      <div className="text-center py-8 text-gray-500">
                        <Calendar size={48} className="mx-auto mb-2 opacity-50" />
                        <p>No hay citas programadas para este día</p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {dayAppointments.map((appointment) => (
                          <div
                            key={appointment.id}
                            className="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4"
                          >
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                  <Clock size={16} className="text-blue-600" />
                                  <span className="font-semibold text-lg">
                                    {appointment.time} - {calculateEndTime(appointment.time, appointment.duration)}
                                  </span>
                                  <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">
                                    {appointment.duration} min
                                  </span>
                                </div>
                                
                                <div className="flex items-center gap-2 mb-1">
                                  <User size={16} className="text-gray-600" />
                                  <span className="font-medium">{appointment.clientName}</span>
                                </div>
                                
                                {appointment.clientPhone && (
                                  <div className="flex items-center gap-2 mb-1">
                                    <Phone size={16} className="text-gray-600" />
                                    <span className="text-gray-700">{appointment.clientPhone}</span>
                                  </div>
                                )}
                                
                                {appointment.service && (
                                  <p className="text-gray-600 text-sm">{appointment.service}</p>
                                )}
                              </div>
                              
                              <button
                                onClick={() => handleCancelAppointment(appointment.id)}
                                className="text-red-600 hover:text-red-800 p-1 hover:bg-red-100 rounded transition-colors"
                                title="Cancelar cita"
                              >
                                <Trash2 size={18} />
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Formulario de nueva cita */}
                  <div>
                    <h2 className="text-xl font-semibold text-gray-800 mb-4">
                      Horarios disponibles
                    </h2>
                    
                    <div className="bg-gray-50 rounded-lg p-4">
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Duración del masaje:
                        </label>
                        <select
                          value={newAppointment.duration}
                          onChange={(e) => setNewAppointment(prev => ({...prev, duration: e.target.value, time: ''}))}
                          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="45">45 minutos</option>
                          <option value="60">60 minutos</option>
                        </select>
                      </div>

                      <div className="max-h-60 overflow-y-auto">
                        <p className="text-sm text-gray-600 mb-2">
                          Horarios disponibles para masaje de {newAppointment.duration} minutos:
                        </p>
                        <div className="grid grid-cols-3 gap-2">
                          {availableSlots.map((time) => (
                            <button
                              key={time}
                              onClick={() => {
                                setNewAppointment(prev => ({...prev, time}));
                                setShowNewAppointment(true);
                              }}
                              className="bg-white border border-gray-300 rounded px-2 py-1 text-sm hover:bg-blue-50 hover:border-blue-300 transition-colors"
                            >
                              {time}
                            </button>
                          ))}
                        </div>
                        {availableSlots.length === 0 && (
                          <p className="text-gray-500 text-sm">No hay horarios disponibles</p>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Modal de nueva cita */}
                {showNewAppointment && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                      <h3 className="text-lg font-semibold mb-4">Nueva Cita</h3>
                      
                      <div>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Horario:
                          </label>
                          <select
                            value={newAppointment.time}
                            onChange={(e) => setNewAppointment(prev => ({...prev, time: e.target.value}))}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">Seleccionar horario</option>
                            {availableSlots.map((time) => (
                              <option key={time} value={time}>{time}</option>
                            ))}
                          </select>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Duración:
                          </label>
                          <select
                            value={newAppointment.duration}
                            onChange={(e) => setNewAppointment(prev => ({...prev, duration: e.target.value, time: ''}))}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="45">45 minutos</option>
                            <option value="60">60 minutos</option>
                          </select>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Nombre del cliente: *
                          </label>
                          <input
                            type="text"
                            value={newAppointment.clientName}
                            onChange={(e) => setNewAppointment(prev => ({...prev, clientName: e.target.value}))}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Teléfono:
                          </label>
                          <input
                            type="tel"
                            value={newAppointment.clientPhone}
                            onChange={(e) => setNewAppointment(prev => ({...prev, clientPhone: e.target.value}))}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                          />
                        </div>

                        <div className="mb-6">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de masaje:
                          </label>
                          <input
                            type="text"
                            value={newAppointment.service}
                            onChange={(e) => setNewAppointment(prev => ({...prev, service: e.target.value}))}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="Ej: Relajante, Deportivo, Terapéutico..."
                          />
                        </div>

                        <div className="flex gap-3">
                          <button
                            onClick={handleAddAppointment}
                            className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                          >
                            Agendar Cita
                          </button>
                          <button
                            onClick={() => setShowNewAppointment(false)}
                            className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                          >
                            Cancelar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<MassageScheduler />, document.getElementById('root'));
    </script>
</body>
</html>
