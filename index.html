import React, { useState, useEffect } from 'react';
import { Calendar, Clock, User, Phone, Trash2, Plus } from 'lucide-react';

const MassageScheduler = () => {
  const [appointments, setAppointments] = useState([]);
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [showNewAppointment, setShowNewAppointment] = useState(false);
  const [newAppointment, setNewAppointment] = useState({
    time: '',
    duration: '60',
    clientName: '',
    clientPhone: '',
    service: ''
  });

  // Generar slots de tiempo disponibles
  const generateTimeSlots = () => {
    const slots = [];
    for (let hour = 8; hour < 16; hour++) {
      for (let minute = 0; minute < 60; minute += 15) {
        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        slots.push(timeString);
      }
    }
    return slots;
  };

  const timeSlots = generateTimeSlots();

  // Verificar si un slot está disponible
  const isSlotAvailable = (time, duration) => {
    const [hours, minutes] = time.split(':').map(Number);
    const startTime = hours * 60 + minutes;
    const endTime = startTime + parseInt(duration);
    
    // Verificar si excede las 16:00 (960 minutos desde medianoche)
    if (endTime > 16 * 60) return false;

    const dayAppointments = appointments.filter(app => app.date === selectedDate);
    
    return !dayAppointments.some(appointment => {
      const [appHours, appMinutes] = appointment.time.split(':').map(Number);
      const appStart = appHours * 60 + appMinutes;
      const appEnd = appStart + parseInt(appointment.duration);
      
      return (startTime < appEnd && endTime > appStart);
    });
  };

  // Obtener slots disponibles para la duración seleccionada
  const getAvailableSlots = (duration) => {
    return timeSlots.filter(time => isSlotAvailable(time, duration));
  };

  // Manejar nueva cita
  const handleAddAppointment = () => {
    if (!newAppointment.time || !newAppointment.clientName) {
      alert('Por favor completa los campos obligatorios.');
      return;
    }
    
    if (!isSlotAvailable(newAppointment.time, newAppointment.duration)) {
      alert('Este horario no está disponible. Por favor selecciona otro.');
      return;
    }

    const appointment = {
      id: Date.now(),
      date: selectedDate,
      ...newAppointment
    };
    
    setAppointments([...appointments, appointment]);
    setNewAppointment({
      time: '',
      duration: '60',
      clientName: '',
      clientPhone: '',
      service: ''
    });
    setShowNewAppointment(false);
  };

  // Cancelar cita
  const cancelAppointment = (id) => {
    if (confirm('¿Estás seguro de que quieres cancelar esta cita?')) {
      setAppointments(appointments.filter(app => app.id !== id));
    }
  };

  // Obtener citas del día seleccionado
  const getDayAppointments = () => {
    return appointments
      .filter(app => app.date === selectedDate)
      .sort((a, b) => a.time.localeCompare(b.time));
  };

  // Formatear fecha
  const formatDate = (dateString) => {
    const date = new Date(dateString + 'T00:00:00');
    return date.toLocaleDateString('es-ES', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  };

  const dayAppointments = getDayAppointments();

  return (
    <div className="max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
      <div className="bg-white rounded-lg shadow-xl p-6">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
            <Calendar className="text-blue-600" />
            Agenda de Masajes
          </h1>
          <button
            onClick={() => setShowNewAppointment(true)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 transition-colors"
          >
            <Plus size={20} />
            Nueva Cita
          </button>
        </div>

        {/* Selector de fecha */}
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Seleccionar fecha:
          </label>
          <input
            type="date"
            value={selectedDate}
            onChange={(e) => setSelectedDate(e.target.value)}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <p className="text-sm text-gray-600 mt-1 capitalize">
            {formatDate(selectedDate)}
          </p>
        </div>

        {/* Lista de citas del día */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              Citas programadas ({dayAppointments.length})
            </h2>
            
            {dayAppointments.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                <Calendar size={48} className="mx-auto mb-2 opacity-50" />
                <p>No hay citas programadas para este día</p>
              </div>
            ) : (
              <div className="space-y-3">
                {dayAppointments.map((appointment) => (
                  <div
                    key={appointment.id}
                    className="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <Clock size={16} className="text-blue-600" />
                          <span className="font-semibold text-lg">
                            {appointment.time} - {
                              (() => {
                                const [hours, minutes] = appointment.time.split(':').map(Number);
                                const endMinutes = hours * 60 + minutes + parseInt(appointment.duration);
                                const endHours = Math.floor(endMinutes / 60);
                                const endMins = endMinutes % 60;
                                return `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
                              })()
                            }
                          </span>
                          <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">
                            {appointment.duration} min
                          </span>
                        </div>
                        
                        <div className="flex items-center gap-2 mb-1">
                          <User size={16} className="text-gray-600" />
                          <span className="font-medium">{appointment.clientName}</span>
                        </div>
                        
                        {appointment.clientPhone && (
                          <div className="flex items-center gap-2 mb-1">
                            <Phone size={16} className="text-gray-600" />
                            <span className="text-gray-700">{appointment.clientPhone}</span>
                          </div>
                        )}
                        
                        {appointment.service && (
                          <p className="text-gray-600 text-sm">{appointment.service}</p>
                        )}
                      </div>
                      
                      <button
                        onClick={() => cancelAppointment(appointment.id)}
                        className="text-red-600 hover:text-red-800 p-1 hover:bg-red-100 rounded transition-colors"
                        title="Cancelar cita"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Formulario de nueva cita */}
          <div>
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              Horarios disponibles
            </h2>
            
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Duración del masaje:
                </label>
                <select
                  value={newAppointment.duration}
                  onChange={(e) => setNewAppointment({...newAppointment, duration: e.target.value})}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                >
                  <option value="45">45 minutos</option>
                  <option value="60">60 minutos</option>
                </select>
              </div>

              <div className="max-h-60 overflow-y-auto">
                <p className="text-sm text-gray-600 mb-2">
                  Horarios disponibles para masaje de {newAppointment.duration} minutos:
                </p>
                <div className="grid grid-cols-3 gap-2">
                  {getAvailableSlots(newAppointment.duration).map((time) => (
                    <button
                      key={time}
                      onClick={() => {
                        setNewAppointment({...newAppointment, time});
                        setShowNewAppointment(true);
                      }}
                      className="bg-white border border-gray-300 rounded px-2 py-1 text-sm hover:bg-blue-50 hover:border-blue-300 transition-colors"
                    >
                      {time}
                    </button>
                  ))}
                </div>
                {getAvailableSlots(newAppointment.duration).length === 0 && (
                  <p className="text-gray-500 text-sm">No hay horarios disponibles</p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Modal de nueva cita */}
        {showNewAppointment && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg p-6 w-full max-w-md">
              <h3 className="text-lg font-semibold mb-4">Nueva Cita</h3>
              
              <div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Horario:
                  </label>
                  <select
                    value={newAppointment.time}
                    onChange={(e) => setNewAppointment({...newAppointment, time: e.target.value})}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">Seleccionar horario</option>
                    {getAvailableSlots(newAppointment.duration).map((time) => (
                      <option key={time} value={time}>{time}</option>
                    ))}
                  </select>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Duración:
                  </label>
                  <select
                    value={newAppointment.duration}
                    onChange={(e) => setNewAppointment({...newAppointment, duration: e.target.value, time: ''})}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="45">45 minutos</option>
                    <option value="60">60 minutos</option>
                  </select>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Nombre del cliente: *
                  </label>
                  <input
                    type="text"
                    value={newAppointment.clientName}
                    onChange={(e) => setNewAppointment({...newAppointment, clientName: e.target.value})}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Teléfono:
                  </label>
                  <input
                    type="tel"
                    value={newAppointment.clientPhone}
                    onChange={(e) => setNewAppointment({...newAppointment, clientPhone: e.target.value})}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Tipo de masaje:
                  </label>
                  <input
                    type="text"
                    value={newAppointment.service}
                    onChange={(e) => setNewAppointment({...newAppointment, service: e.target.value})}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                    placeholder="Ej: Relajante, Deportivo, Terapéutico..."
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    type="button"
                    onClick={handleAddAppointment}
                    className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    Agendar Cita
                  </button>
                  <button
                    type="button"
                    onClick={() => setShowNewAppointment(false)}
                    className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default MassageScheduler;
